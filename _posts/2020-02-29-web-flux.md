---
layout: post
title:  "[Spring] WebFluxë€?"
date:   '2020-02-29 14:00:00'
author: Heeye
categories: Spring
tags: Spring
---

## WebFlux?
Spring Framwork5ì—ì„œ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ëª¨ë“ˆì´ë‹¤. web-fluxëŠ” client, serverì—ì„œ reactive ìŠ¤íƒ€ì¼ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì„ ë„ì™€ì£¼ëŠ” ëª¨ë“ˆì´ë¼ê³  í•œë‹¤.
ìŠ¤í”„ë§ ê³µì‹ë¬¸ì„œì— ìˆëŠ”, Spring WebFluxì— ëŒ€í•œ ì†Œê°œì™€ Reactiveì— ëŒ€í•œ ê°œë…ì„ ì •ë¦¬í•œë‹¤.

### Web on Reactive Stack (Version 5.2.4.RELEASE)

ì›ë˜ ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ëŠ” Servlet APIì™€ Servlet ì»¨í…Œì´ë„ˆë¡œ ì´ë¤„ì¡ŒëŠ”ë° 5ë²„ì „ì—ì„œ WebFluxê°€ ì¶”ê°€ ëë‹¤. WebFluxëŠ” reactive-stack web frameworkì´ë©° non-blockingì— Reactive streamì„ ì§€ì›í•œë‹¤. webmvcë‚˜ webflux ë‘˜ë‹¤ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

WebFluxê°€ ìƒê¸´ ì´ìœ ëŠ”,

 (1) ì ì€ ì–‘ì˜ ìŠ¤ë ˆë“œì™€ ìµœì†Œí•œì˜ í•˜ë“œì›¨ì–´ ìì›ìœ¼ë¡œ ë™ì‹œì„±ì„ í•¸ë“¤ë§í•˜ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡Œë‹¤. ì„œë¸”ë¦¿ 3.1ì´ ë…¼ë¸”ë¡œí‚¹ì„ ì§€ì›í•˜ì§€ë§Œ, ì¼ë¶€ë¶„ì´ë‹¤. ì´ëŠ” ìƒˆë¡œìš´ ê³µí†µ APIê°€ ìƒê¸´ ì´ìœ ê°€ ëìœ¼ë©°, nettyì™€ ê°™ì€ ì˜ ë§Œë“¤ì–´ì§„ async, non-blocking ì„œë²„ë¥¼ ì‚¬ìš©í•œë‹¤.

 (2) í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë° ë•Œë¬¸ì´ë‹¤. Java5ì—ì„œ Rest controllersë‚˜ unit testê°€ ë§Œë“¤ì–´ì§€ê³ , Java8ì—ì„œëŠ” í•¨ìˆ˜í˜• APIë¥¼ ìœ„í•œ Lambda í‘œí˜„ì‹ì´ ì¶”ê°€ëë‹¤. ì´ëŠ” ë…¼ë¸”ë¡œí‚¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ APIì˜ í† ëŒ€ê°€ ëë‹¤.

non-blockingì´ë‚˜ functionalì´ë€ ë‹¨ì–´ëŠ” ì˜ ì™€ë‹¿ì§€ë§Œ, reactiveë¼ëŠ” ë‹¨ì–´ëŠ” ì˜ ì™€ë‹¿ì§€ ì•ŠëŠ”ë‹¤. reactiveë¼ëŠ” ê±´ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ” ê²ƒì¼ê¹Œ?

"reactive"ë¼ëŠ” ê±´ ë³€í™”ì— ë°˜ì‘í•˜ê²Œ ë§Œë“¤ì–´ì§„ í”„ë¡œê·¸ë˜ë° ëª¨ë¸ì´ë‹¤. I/O ì´ë²¤íŠ¸ì— ë”°ë¼ ë„¤íŠ¸ì›Œí¬ ì»´í¬ë„ŒíŠ¸ê°€ ë°˜ì‘í•˜ê³  ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë‚˜ ë‹¤ë¥¸ ê²ƒë“¤ì— UI ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë°˜ì‘í•˜ëŠ” ê²ƒê³¼ ê°™ì€. ì¦‰, non-blockingì€ reactiveí•œ ê²ƒì´ë‹¤. ë¸”ë½í‚¹ì„ í•˜ëŠ” ëŒ€ì‹ ì— ì˜¤í¼ë ˆì´ì…˜ì´ ì™„ë£Œë˜ê±°ë‚˜ ë°ì´í„°ê°€ ìœ íš¨í•˜ë‹¤ëŠ” ê²ƒì— ë”°ë¥¸ notiì— ë°˜ì‘ì„ í•˜ëŠ” ê²ƒì´ë‹¤.

ë™ê¸°ì„±ì—ì„œëŠ”, ë¸”ë¡œí‚¹ ì½œì€ ì½œëŸ¬ë¥¼ ê¸°ë‹¤ë¦¬ê²Œ í•˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ í˜•íƒœì´ë‹¤. ë…¼ë¸”ë¡œí‚¹ ì½”ë“œì—ì„œëŠ” ë¹ ë¥¸ ìƒì‚°ìê°€ ëª©ì ì§€ë¥¼ ì•ì§€ë¥´ì§€ ì•Šê²Œ ì´ë²¤íŠ¸ ì†ë„ë¥¼ ì œì–´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. reactive streamì€ (java9ì— í¬í•¨ëœ) ë¹„ë™ê¸°ì„± ì»´í¬ë„ŒíŠ¸ê°„ì˜ ìƒí˜¸ì‘ìš©ì— ì •ì˜ëœ ì‘ì€ ìŠ¤í™ì´ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, publisherê°€ subscriberê°€ ì‘ë‹µì— ì“¸ ë°ì´í„°ë¥¼ ìƒì‚°í•œë‹¤ê³  í•˜ì. reactive streamì˜ ì£¼ ëª©ì ì€ subscriberê°€ publisherê°€ ìƒì‚°í•˜ëŠ” ë°ì´í„°ì˜ ì†ë„ë¥¼ ì œì–´í•˜ëŠ” ê²ƒì´ë‹¤.

ê²°êµ­ springì´ ê°€ì§€ì§€ ëª»í–ˆë˜ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì„ ë³´ì™„í•˜ê¸° ìœ„í•œ Spring ë²„ì „ì´ë¼ëŠ” ì˜ë¯¸ì¸ ê²ƒ ê°™ë‹¤. ê·¸ ë²„ì „ì´ Spring5ì´ê³  webflux ëª¨ë“ˆì„ ì‚¬ìš©í•œ ê²ƒì´ë‹¤.

ğŸ”†
WebFluxëŠ” ì•„ë˜ì™€ ê°™ì€ ìš©ë„ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì¶”ì²œ í•œë‹¤ê³  í•©ë‹ˆë‹¤. (by í† ë¹„)

- ë¹„ë™ê¸° - ë…¼ë¸”ë¡í‚¹ ë¦¬ì•¡í‹°ë¸Œ ê°œë°œì— ì‚¬ìš©
- íš¨ìœ¨ì ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê³ ì„±ëŠ¥ ì›¹ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ
- ì„œë¹„ìŠ¤ê°„ í˜¸ì¶œì´ ë§ì€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì— ì í•©

ì¶œì²˜: https://kimyhcj.tistory.com/343 [ê¸°ì–µê³¼ ê¸°ë¡]


ğŸ”†
'Spring WebFluxëŠ” ì–´ë–»ê²Œ ì ì€ ë¦¬ì†ŒìŠ¤ë¡œ ë§ì€ íŠ¸ë˜í”½ì„ ê°ë‹¹í• ê¹Œ?'ë€ ê¶ê¸ˆì¦ì„ ì‹œì‘ìœ¼ë¡œ ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤. ì´ì— ëŒ€í•œ ë‹µì€ I/Oë¥¼ Non Blockkngì„ ì´ìš©í•˜ì—¬ ì˜ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ Requestë¥¼ Event-Drivenì„ í†µí•´ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•˜ë‹¤.

ì¶œì²˜ : https://alwayspr.tistory.com/44

### ì •ë¦¬
webfluxë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê±´, ìœ„ì™€ ê°™ì€ ê²½ìš°ì— ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì´ë‹¤. ì‚¬ì‹¤ ë™ê¸°í”„ë¡œê·¸ë˜ë°ì´ ì½”ë“œë¥¼ ì‘ì„±í•˜ê±°ë‚˜ ë””ë²„ê¹…í•˜ëŠ” ë°ì— ë” ì‰½ê¸° ë•Œë¬¸ì—, ë™ì¼í•œ ë§ë¡œ ìƒì‚°ì„±ì´ ë†’ë‹¤ê³  í‘œí˜„í•  ìˆ˜ ìˆë‹¤. (ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì€ íŠ¸ë ˆì´ì‹±í•˜ê¸°ê°€ ì¼ë‹¨ ì–´ë µë‹¤.) ê·¸ë¦¬ê³  ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° ì¤‘ì—, ë™ê¸°í™”ë˜ëŠ” ë¶€ë¶„ì˜ ì½”ë“œê°€ ìˆë‹¤ë©´ ê·¸ ë‚˜ë¨¸ì§€ ë¹„ë™ê¸° ì½”ë“œë¡œ ì‘ì„±ëœ ê±´ ë¬´ì˜ë¯¸í•´ì§ˆ ìˆ˜ ìˆë‹¤. ë™ê¸°í™”ë˜ëŠ” ë¶€ë¶„ì—ì„œ ê²°êµ­ ë¸”ë½í‚¹ì´ ë˜ê¸° ë•Œë¬¸ì¸ ê²ƒ ê°™ë‹¤. Javaì—ì„œ DB connection ìª½ì´ ë…¼ë¸”ë¡œí‚¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì˜ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤. R2DBCì²˜ëŸ¼ ê°œë°œì´ ì§„í–‰ ì¤‘ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬, ìµœê·¼ì— releaseëœ jasync sql, MongoDB, Redis ë“±ì˜ NoSQLì€ ì§€ì›ì¤‘ì´ë¼ê³  í•œë‹¤.

webfluxëŠ” ë¶„ëª… ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì— ì í•©í•œ ëª¨ë“ˆì¸ ê±´ ë¶„ëª…í•˜ì§€ë§Œ, webfluxë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì— ëŒ€í•œ ì´í•´ê°€ ìš°ì„ ì‹œ ë¼ì•¼ í•  ê²ƒ ê°™ë‹¤.

*ìš”ìƒˆ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•œ ê°œë°œì„ í•˜ê³  ìˆëŠ”ë°, ì„œë¹„ìŠ¤ ê°„ì˜ í˜¸ì¶œì´ ë¹ˆë²ˆí•œ ê²Œ ë­”ì§€ ì—¬ì‹¤íˆ ëŠê¼ˆë‹¤. ê·¸ë¦¬ê³  RestTemplateê³¼ ê°™ì´ serviceì½œì„ í•˜ëŠ” ëª¨ë“ˆì´ Blocking I/Oì¼ ë•Œì˜ í•œê³„ì ë„ ì—¬ì‹¤íˆ! asyncRestTemplateì„ ì‚¬ìš©í•´ì„œ Blocking I/Oì˜ í•œê³„ë¥¼ ì¡°ê¸ˆì€ ë³´ì™„í•˜ê³  í•˜ê¸´ í–ˆìœ¼ë‚˜, í™•ì‹¤íˆ **ì„œë¹„ìŠ¤ë¥¼ ì˜ê²Œ ìª¼ê°  ìƒíƒœì˜ ì•„í‚¤í…ì²˜ì—ëŠ” Non-Blocking I/OëŠ” í•„ìš”í•˜ë‹¤.***

Blocking I/O
``` java
@Test
public void blocking() {
    final RestTemplate restTemplate = new RestTemplate();

    final StopWatch stopWatch = new StopWatch();
    stopWatch.start();

    for (int i = 0; i < 3; i++) {
        final ResponseEntity<String> response =
                restTemplate.exchange(THREE_SECOND_URL, HttpMethod.GET, HttpEntity.EMPTY, String.class);
        assertThat(response.getBody()).contains("success");
    }

    stopWatch.stop();

    System.out.println(stopWatch.getTotalTimeSeconds());
}
```
Springì˜ HTTP ìš”ì²­ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ RestTemplateì„ ì‚¬ìš©í•˜ì—¬ 3ì´ˆê°€ ê±¸ë¦¬ëŠ” APIë¥¼ 3ë²ˆ í˜¸ì¶œí•˜ì˜€ë‹¤. ê²°ê³¼ëŠ” ì—¬ëŸ¬ë¶„ë„ ì•Œë‹¤ì‹œí”¼ 9.xxì´ˆê°€ ë‚˜ì˜¨ë‹¤. ì´ìœ ëŠ” I/Oê°€ ìš”ì²­ ì¤‘ì¼ ë•Œì—ëŠ” ì•„ë¬´ ì‘ì—…ë„ í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì´ë‹¤.

Non Blocking I/O
``` java
@Test
public void nonBlocking3() throws InterruptedException {
    final StopWatch stopWatch = new StopWatch();
    stopWatch.start();
    for (int i = 0; i < LOOP_COUNT; i++) {
        this.webClient
                .get()
                .uri(THREE_SECOND_URL)
                .retrieve()
                .bodyToMono(String.class)
                .subscribe(it -> {
                    count.countDown();
                    System.out.println(it);
                });
    }

    count.await(10, TimeUnit.SECONDS);
    stopWatch.stop();
    System.out.println(stopWatch.getTotalTimeSeconds());
}
```
WebFluxì—ì„œ ì œê³µí•˜ëŠ” WebClientë¥¼ ì‚¬ìš©í•´ì„œ ìœ„ì™€ ë™ì¼í•˜ê²Œ 3ì´ˆê°€ ê±¸ë¦¬ëŠ” APIë¥¼ í˜¸ì¶œí•˜ì˜€ë‹¤. forë¬¸ ì•ˆì˜ ë³€ìˆ˜ì¸ LOOP_COUNTëŠ” 100ìœ¼ë¡œ ì½”ë“œìƒì—ì„œ ì„¤ì •ë˜ì–´ìˆë‹¤. 3ì´ˆ ê±¸ë¦¬ëŠ” APIë¥¼ 100ë²ˆ í˜¸ì¶œí•œë‹¤ í•˜ë”ë¼ë„ 3.xxì´ˆ ë°–ì— ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤. ë” ë‚˜ì•„ê°€ì„œ LOOP_COUNTë¥¼ 1000ìœ¼ë¡œ ë³€ê²½í•˜ë”ë¼ë„ í•„ìì˜ ì»´í“¨í„°ì—ì„œëŠ” 4.xxì´ˆ ë°–ì— ê±¸ë¦¬ì§€ ì•ŠëŠ”ë‹¤. Blocking I/Oì™€ ë¹„êµí•´ë´¤ì„ ë•Œ ì •ë§ íš¨ìœ¨ì ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.

ë§Œì•½, Blockingì„ ìœ„ì²˜ëŸ¼ ë§ì€ ìš”ì²­ì„ ë™ì‹œì— ì²˜ë¦¬í•˜ë ¤ë©´ ê·¸ ë§Œí¼ì˜ Threadì´ ìƒì„±ë˜ì–´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë‚˜ ì´ë ‡ê²Œ ì²˜ë¦¬í•œë‹¤ í•´ë„ Context Swichingì— ì˜í•œ ì˜¤ë²„í—¤ë“œê°€ ì¡´ì¬í•  ê²ƒì´ë‹¤.

[ì¶œì²˜ : AlwaysPr Blog](https://alwayspr.tistory.com/44)

---


This part of the documentation covers support for reactive-stack web applications built on a Reactive Streams API to run on non-blocking servers, such as Netty, Undertow, and Servlet 3.1+ containers. Individual chapters cover the Spring WebFlux framework, the reactive WebClient, support for testing, and reactive libraries. For Servlet-stack web applications, see Web on Servlet Stack.

1. Spring WebFlux
The original web framework included in the Spring Framework, Spring Web MVC, was purpose-built for the Servlet API and Servlet containers. The reactive-stack web framework, Spring WebFlux, was added later in version 5.0. It is fully non-blocking, supports Reactive Streams back pressure, and runs on such servers as Netty, Undertow, and Servlet 3.1+ containers.

Both web frameworks mirror the names of their source modules (spring-webmvc and spring-webflux) and co-exist side by side in the Spring Framework. Each module is optional. Applications can use one or the other module or, in some cases, bothâ€‰â€”â€‰for example, Spring MVC controllers with the reactive WebClient.

1.1. Overview
Why was Spring WebFlux created?

Part of the answer is the need for a non-blocking web stack to handle concurrency with a small number of threads and scale with fewer hardware resources. Servlet 3.1 did provide an API for non-blocking I/O. However, using it leads away from the rest of the Servlet API, where contracts are synchronous (Filter, Servlet) or blocking (getParameter, getPart). This was the motivation for a new common API to serve as a foundation across any non-blocking runtime. That is important because of servers (such as Netty) that are well-established in the async, non-blocking space.

The other part of the answer is functional programming. Much as the addition of annotations in Java 5 created opportunities (such as annotated REST controllers or unit tests), the addition of lambda expressions in Java 8 created opportunities for functional APIs in Java. This is a boon for non-blocking applications and continuation-style APIs (as popularized by CompletableFuture and ReactiveX) that allow declarative composition of asynchronous logic. At the programming-model level, Java 8 enabled Spring WebFlux to offer functional web endpoints alongside annotated controllers.

1.1.1. Define â€œReactiveâ€
We touched on â€œnon-blockingâ€ and â€œfunctionalâ€ but what does reactive mean?

The term, â€œreactive,â€ refers to programming models that are built around reacting to changeâ€‰â€”â€‰network components reacting to I/O events, UI controllers reacting to mouse events, and others. In that sense, non-blocking is reactive, because, instead of being blocked, we are now in the mode of reacting to notifications as operations complete or data becomes available.

There is also another important mechanism that we on the Spring team associate with â€œreactiveâ€ and that is non-blocking back pressure. In synchronous, imperative code, blocking calls serve as a natural form of back pressure that forces the caller to wait. In non-blocking code, it becomes important to control the rate of events so that a fast producer does not overwhelm its destination.

Reactive Streams is a small spec (also adopted in Java 9) that defines the interaction between asynchronous components with back pressure. For example a data repository (acting as Publisher) can produce data that an HTTP server (acting as Subscriber) can then write to the response. The main purpose of Reactive Streams is to let the subscriber to control how quickly or how slowly the publisher produces data.

[ìŠ¤í”„ë§ ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html)
