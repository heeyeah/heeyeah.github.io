---
title: 'memory leak 1. JVM êµ¬ì¡°'
date: 2020-12-10 00:00:00
category: java
draft: true
---

# Index

1. memory leakì´ ë°œìƒí•˜ëŠ” ì´ìœ ?
2. jvm memory êµ¬ì¡° (1.8~)
3. jvm monitoring
4. garbage collection íŠœë‹



## Java 1.8ë¶€í„° JVM ë©”ëª¨ë¦¬ êµ¬ì¡° ë³€í™” (permGen â†’ metaspace)
java 1.8ë¶€í„° permGen (permenant Generation) ì˜ì—­ì´ ì‚¬ë¼ì§€ê³ , ëŒ€ì‹ ì— Metaspace ì˜ì—­ì´ ìƒê²¼ë‹¤.
ê°„ë‹¨íˆ ì„¤ëª…í•˜ìë©´, permGenì€ jvmì— ì˜í•´ í¬ê¸°ê°€ ê°•ì œë˜ë˜ ì˜ì—­ìœ¼ë¡œ OOMì„ ë°œìƒì‹œí‚¤ëŠ” ì›ì¸ ì¤‘ í•˜ë‚˜ì˜€ë‹¤ê³  í•œë‹¤.
metaspace ì˜ì—­ì´ permGenì˜ ëŒ€ì²´ ì—­í• ì„ í•˜ëŠ”ë°, metaspaceëŠ” native memoryì˜ì—­ìœ¼ë¡œ OSê°€ ìë™ìœ¼ë¡œ í¬ê¸°ë¥¼ ì¡°ì ˆí•œë‹¤.
ê·¸ ê²°ê³¼ ê¸°ì¡´ê³¼ ë¹„êµí•´ í° ë©”ëª¨ë¦¬ ì˜ì—­ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤!
ë˜í•œ metaspaceëŠ” heapì´ ì•„ë‹Œ native ë©”ëª¨ë¦¬ ì˜ì—­ì´ê¸° ë•Œë¬¸ì—, ê°œë°œìê°€ ì˜ì—­ í™•ë³´ì˜ ìƒí•œì„ í¬ê²Œ ì˜ì‹í•˜ì§€ ì•Šì•„ë„ ë˜ê²Œ ë˜ì—ˆë‹¤(?)ê³  í•œë‹¤.

> Perm ì˜ì—­ì€ ë³´í†µ Classì˜ Meta ì •ë³´ë‚˜ Methodì˜ Meta ì •ë³´, Static ë³€ìˆ˜ì™€ ìƒìˆ˜ ì •ë³´ë“¤ì´ ì €ì¥ë˜ëŠ” ê³µê°„ìœ¼ë¡œ í”íˆ ë©”íƒ€ë°ì´í„° ì €ì¥ ì˜ì—­ì´ë¼ê³ ë„ í•œë‹¤. ì´ ì˜ì—­ì€ Java 8 ë¶€í„°ëŠ” Native ì˜ì—­ìœ¼ë¡œ ì´ë™í•˜ì—¬ Metaspace ì˜ì—­ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆë‹¤. (ë‹¤ë§Œ, ê¸°ì¡´ Perm ì˜ì—­ì— ì¡´ì¬í•˜ë˜ Static ObjectëŠ” Heap ì˜ì—­ìœ¼ë¡œ ì˜®ê²¨ì ¸ì„œ GCì˜ ëŒ€ìƒì´ ìµœëŒ€í•œ ë  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤)


## JVM êµ¬ì¡°
1. JVMì€ heapê³¼ metaspaceë¡œ ë‚˜ë‰œë‹¤.
2. heapì€ young generationê³¼ old generationìœ¼ë¡œ ë‚˜ë‰œë‹¤.
3. young generationì€ eden, survival 0, survival 1ìœ¼ë¡œ ë‚˜ë‰œë‹¤.
4. old generationì€ old generationì´ë‹¤.

![ì¶œì²˜:https://www.waitingforcode.com/off-heap/on-heap-off-heap-storage/read](./images/jvm_heap_java8.png)


### ìƒì„±ì£¼ê¸° - Generation in JVM
ìƒˆë¡œ ìƒê¸´ class instanceë“¤ì€ ì œì¼ ë¨¼ì € eden ì˜ì—­ì— í• ë‹¹ëœë‹¤. ê·¸ë¦¬ê³  ì—¬ê¸°ì„œ ê³„ì† gcê°€ ì¼ì–´ë‚œë‹¤.
edenì—ì„œ ì‚´ì•„ë‚¨ì€ class instanceë“¤ì€ survivor spaceë¡œ ì˜®ê²¨ì§€ë©°, jvm ì „ì²´ë¥¼ ë´¤ì„ ë•Œ ì‘ì€ ì˜ì—­ì´ë‹¤.
survivor spaceëŠ” 2ê°œê°€ ìˆëŠ”ë°, 2ê°œ ì¤‘ ê¼­ 1ê°œì˜ spaceëŠ” emptyë¡œ ìœ ì§€ê°€ ë˜ê³ , ì´ ì´ìœ ëŠ” fragmentation workë¥¼ í”¼í•˜ê¸° ìœ„í•¨ì´ë¼ê³  í•œë‹¤.

í•˜ì—¬íŠ¼, young generationì€ ë§ ê·¸ëŒ€ë¡œ ê°“ ìƒì„±ëœ instanceë“¤ì˜ ë©”ëª¨ë¦¬ ì˜ì—­ì´ë¼ê³  í•œë‹¤ë©´, old generationì€ ìƒëª…ì£¼ê¸°ê°€ ì˜¤ë˜ëœ instanceë“¤ì˜ ë©”ëª¨ë¦¬ ì˜ì—­ì´ë‹¤.
ìƒëª…ì£¼ê¸°ëŠ” ì–´ë–»ê²Œ ì²´í¬ë¥¼ í•˜ëƒë©´, young generationì—ì„œ garbage actionì—ì„œ 4ë²ˆì„ ì‚´ì•„ ë‚¨ì•˜ë‹¤ê³  ê°€ì •í•˜ë©´, ì´ instaceì˜ ë‚˜ì´ëŠ” 4ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.
old generationì—ì„œ ë°œìƒí•˜ëŠ” ê±´ major collectionì´ë¼ í•˜ê³ , young generationì€ minor collectionì´ë¼ê³  í•œë‹¤.
young generationì— ë¹„í•´ ëŒ€ì²´ì ìœ¼ë¡œ í° ì‚¬ì´ì¦ˆë¥¼ ê°€ì§€ê³ , ë” ê¸´ collection processë¥¼ ê°€ì§„ë‹¤.

minor collectionì—ì„œì˜ gcëŠ” 'stop-the-world'ì— í° ì˜í–¥ì„ ì£¼ì§„ ì•Šìœ¼ë©°, edenì˜ì—­ì´ fullë¡œ ì°¨ê³  ìƒˆë¡œìš´ ê°ì²´ê°€ ìƒì„±ë˜ì§€ ì•Šì„ ë•Œ minor gcê°€ ë°œìƒí•œë‹¤.
major collectionì—ì„œì˜ gcê°€ ìš°ë¦¬ê°€ í”íˆ ì•„ëŠ” ê·¸ gcì´ë©°, major gcê°€ ì¼ì–´ë‚  ë•Œì—” GC Threadë§Œ running ìƒíƒœì´ë‹¤. ëª¨ë“  threadëŠ” ë™ì‘ì„ í•˜ì§€ ì•Šê³  ë©ˆì¶˜ë‹¤.
major gcì˜ ì‹¤í–‰ ì£¼ê¸°ëŠ” old generationì˜ í¬ê¸°ì— ì˜í•´ ê²°ì •ëœë‹¤.


## Garbage Collection íŠœë‹

>ëª¨ë“  Java ê¸°ë°˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ GC íŠœë‹ì„ í•´ì•¼ í• ê¹Œ?

ê²°ë¡ ë¶€í„° ì´ì•¼ê¸°í•˜ë©´ ëª¨ë“  Java ê¸°ë°˜ì˜ ì„œë¹„ìŠ¤ì—ì„œ GC íŠœë‹ì„ ì§„í–‰í•  í•„ìš”ëŠ” ì—†ë‹¤.

GC íŠœë‹ì´ í•„ìš” ì—†ë‹¤ëŠ” ì´ì•¼ê¸°ëŠ” ìš´ì˜ ì¤‘ì¸ Java ê¸°ë°˜ ì‹œìŠ¤í…œì˜ ì˜µì…˜ê³¼ ë™ì‘ì´ ë‹¤ìŒê³¼ ê°™ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

- -Xms ì˜µì…˜ê³¼ â€“Xmx ì˜µì…˜ìœ¼ë¡œë©”ëª¨ë¦¬í¬ê¸°ë¥¼ì§€ì •í–ˆë‹¤.
- -server ì˜µì…˜ì´í¬í•¨ë˜ì–´ìˆë‹¤.
- ì‹œìŠ¤í…œì— Timeout ë¡œê·¸ì™€ê°™ì€ë¡œê·¸ê°€ë‚¨ì§€ì•ŠëŠ”ë‹¤.
ë‹¤ì‹œ ë§í•˜ë©´, ë©”ëª¨ë¦¬ í¬ê¸°ë„ ì§€ì •í•˜ì§€ ì•Šê³  Timeout ë¡œê·¸ê°€ ìˆ˜ë„ ì—†ì´ ì¶œë ¥ëœë‹¤ë©´ ì—¬ëŸ¬ë¶„ì˜ ì‹œìŠ¤í…œì—ì„œ GC íŠœë‹ì„ í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

ê·¸ëŸ°ë° í•œ ê°€ì§€ ê¼­ ëª…ì‹¬í•´ì•¼ í•˜ëŠ” ì ì´ ìˆë‹¤. GC íŠœë‹ì€ ê°€ì¥ ë§ˆì§€ë§‰ì— í•˜ëŠ” ì‘ì—…ì´ë¼ëŠ” ê²ƒì´ë‹¤.

### GC íŠœë‹ì— ìì£¼ ì‚¬ìš©í•˜ëŠ” ì˜µì…˜
- -Xms ì˜µì…˜
- -Xmx ì˜µì…˜
- -XX:NewRation ì˜µì…˜


ê°„í˜¹ Perm ì˜ì—­ì˜ í¬ê¸°ëŠ” ì–´ë–»ê²Œ ì„¤ì •í•´ì•¼ í•˜ëŠ”ì§€ ë¬¸ì˜í•˜ëŠ” ë¶„ë“¤ì´ ìˆë‹¤. Perm ì˜ì—­ì˜ í¬ê¸°ëŠ” OutOfMemoryErrorê°€ ë°œìƒí•˜ê³ , ê·¸ ë¬¸ì œì˜ ì›ì¸ì´ Perm ì˜ì—­ì˜ í¬ê¸° ë•Œë¬¸ì¼ ë•Œì—ë§Œ -XX:PermSize ì˜µì…˜ê³¼ -XX:MaxPermSize ì˜µì…˜ìœ¼ë¡œ ì§€ì •í•´ë„ í° ë¬¸ì œëŠ” ì—†ë‹¤.


### íŠœë‹ ì ˆì°¨
1. GC ìƒí™© ëª¨ë‹ˆí„°ë§
GC ìƒí™©ì„ ëª¨ë‹ˆí„°ë§í•˜ë©° í˜„ì¬ ìš´ì˜ë˜ëŠ” ì‹œìŠ¤í…œì˜ GC ìƒí™©ì„ í™•ì¸í•´ì•¼ í•œë‹¤. "Garbage Collection ëª¨ë‹ˆí„°ë§ ë°©ë²•" ê¸€ì— ë‹¤ì–‘í•œ GC ëª¨ë‹ˆí„°ë§ ë°©ë²•ì„ ì†Œê°œí–ˆìœ¼ë‹ˆ ì°¸ì¡°í•˜ê¸° ë°”ë€ë‹¤.

2. ëª¨ë‹ˆí„°ë§ ê²°ê³¼ ë¶„ì„ í›„ GC íŠœë‹ ì—¬ë¶€ ê²°ì •
GC ìƒí™©ì„ í™•ì¸í•œ í›„ì—ëŠ”, ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  GC íŠœë‹ ì—¬ë¶€ë¥¼ ê²°ì •í•´ì•¼ í•œë‹¤. ë¶„ì„í•œ ê²°ê³¼ë¥¼ í™•ì¸í–ˆëŠ”ë° GC ìˆ˜í–‰ì— ì†Œìš”ëœ ì‹œê°„ì´ 0.1~0.3ì´ˆ ë°–ì— ì•ˆ ëœë‹¤ë©´ êµ³ì´ GC íŠœë‹ì— ì‹œê°„ì„ ë‚­ë¹„í•  í•„ìš”ëŠ” ì—†ë‹¤. í•˜ì§€ë§Œ GC ìˆ˜í–‰ ì‹œê°„ì´ 1~3ì´ˆ, ì‹¬ì§€ì–´ 10ì´ˆê°€ ë„˜ëŠ” ìƒí™©ì´ë¼ë©´ GC íŠœë‹ì„ ì§„í–‰í•´ì•¼ í•œë‹¤.

>ì°¸ê³ 
> heap dumpëŠ” jmap ì´ë¼ëŠ” ëª…ë ¹ì–´ë¡œ ìƒì„±ê°€ëŠ¥. jdkì— í¬í•¨ë˜ì–´ ìˆë‹¤.
> gc ì²´í¬ëŠ” jstat -gcutil ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©.

ê¸°ì¤€ì´ ì ˆëŒ€ì ì´ì§„ ì•Šìœ¼ë‚˜, ë‹¤ìŒê³¼ ê°™ì€ ì¼ë°˜ì ì¸ ê¸°ì¤€ì´ ìˆë‹¤. (ì–´í”Œë¦¬ì¼€ì´ì…˜ ì„±ê²©, ì‹œìŠ¤í…œë§ˆë‹¤ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì ˆëŒ€ì ì¸ ê¸°ì¤€ì´ ì•„ë‹˜)

GCê°€ ìˆ˜í–‰ë˜ëŠ” ì‹œê°„ì„ í™•ì¸í–ˆì„ ë•Œ ê²°ê³¼ê°€ ë‹¤ìŒì˜ ì¡°ê±´ì— ëª¨ë‘ ë¶€í•©í•œë‹¤ë©´ GC íŠœë‹ì´ í•„ìš” ì—†ë‹¤.

Minor GCì˜ì²˜ë¦¬ì‹œê°„ì´ë¹ ë¥´ë‹¤(50msë‚´ì™¸).
Minor GC ì£¼ê¸°ê°€ë¹ˆë²ˆí•˜ì§€ì•Šë‹¤(10ì´ˆë‚´ì™¸).
Full GCì˜ì²˜ë¦¬ì‹œê°„ì´ë¹ ë¥´ë‹¤(ë³´í†µ1ì´ˆì´ë‚´).
Full GC ì£¼ê¸°ê°€ë¹ˆë²ˆí•˜ì§€ì•Šë‹¤(10ë¶„ì— 1íšŒ).

---

ğŸ’¡ì°¸ê³ ìë£Œ
- https://johngrib.github.io/wiki/java8-why-permgen-removed/
- https://yaboong.github.io/java/2018/06/09/java-garbage-collection/
- https://www.waitingforcode.com/off-heap/on-heap-off-heap-storage/read
- https://www.baeldung.com/java-memory-leaks
- [(Naver D2)Garbage Collection íŠœë‹](https://d2.naver.com/helloworld/37111)
